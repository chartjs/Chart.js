<!doctype html>
<html>

<head>
	<title> Realtime data update </title>
	<script src="../../dist/Chart.bundle.js"></script>
	<script src="../utils.js"></script>
	<style>
		canvas {
			-moz-user-select: none;
			-webkit-user-select: none;
			-ms-user-select: none;
		}
	</style>
</head>

<body>
	<div style="width: 75%;">
		<canvas id="canvas"></canvas>
	</div>
	<br>
	<br>
	<button id="pause">Pause/Resume</button>
	<script>
		var timeFormat = 'MM/DD/YYYY HH:mm'
		var pause = false

		function moveToNewest(chart) {
			var firstTick = chart.scales['x-axis-0'].min
			var lastTick = chart.scales['x-axis-0'].max
			var data = chart.config.data.datasets[0].data
			if (data.length) {
				if (data[data.length - 1].x > lastTick) {
					chart.scales['x-axis-0'].options.time.max = data[data.length - 1].x + (lastTick - firstTick) / 10
					chart.scales['x-axis-0'].options.time.min = data[data.length - 1].x - ((lastTick - firstTick) / 10) * 9
				}
			}
		}

		Chart.plugins.register({
			beforeInit: function (chart) {
				setInterval(() => {
					if (chart.config.options.live) {
						moveToNewest(chart)
					}
				}, 1000)
			}
		})

		var config = {
			type: 'line',
			data: {
				datasets: [{
					label: 'Dataset',
					fill: false,
					showLine: false,
					borderColor: window.chartColors.red,
					backgroundColor: window.chartColors.red,
					data: Array(60).fill().map((item, index) => {
						return {x: (Date.now() - 60000) + index * 1000, y: randomScalingFactor()}
					})
				}]
			},
			options: {
				live: true,
				title: {
					display: true,
					text: 'Chart.js realtime data example'
				},
				animation: {
					duration: 0
				},
				scales: {
					xAxes: [
						{
							type: "time",
							time: {
								min: Date.now() - 60000,
								max: Date.now() + 0.5 * 60000,
								tooltipFormat: "ll H:mm:ss",
								displayFormats: {
									minute: "H:mm",
									second: "H:mm:ss",
									hour: "H:mm"
								}
							},
							ticks: {
								maxRotation: 0
							}
						}
					]
				}
			}
		};

		window.onload = function () {
			var ctx = document.getElementById('canvas').getContext('2d');
			window.myLine = new Chart(ctx, config);

			window.timer = setInterval(() => {
				if (pause) return
				config.data.datasets[0].data.push({x: Date.now(), y:randomScalingFactor()})
				while (config.data.datasets[0].data.length > 100) {
					config.data.datasets[0].data.shift()
				}
				window.myLine.update();
			},1000)
		};

		document.getElementById('pause').addEventListener('click', function () {
			pause = !pause
		});
	</script>
</body>

</html>